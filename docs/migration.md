## Migration guide

The following section is a short guide on how to migrate various projects types.

**Note:** The migration guides are 1) backend-centric 2) don't explain how to e.g. create "complimentary setup scripts" for databases, IIS instances etc.

## XDT- and Slow Cheetah-based projects

1. Open PowerShell in the solution root and run the following command to get a list of issues:
```powershell
Get-WebProject | Assert-WebProjectConsistency -BuildConfiguration "<your build configuration>"
``` 

2. Solve all the issues. This is usually done by...

    * renaming files
    * changing build actions for configuration and XDT files
    * uninstalling the Slow Cheetah NuGet package from all projects in the solution (read [SlowCheetah NuGet package](/docs/usage.md#SlowCheetah-NuGet-package) for details)
    * manually removing all mentions of Slow Cheetah from the `*.csproj` files in the solution.

3. Add any relevant Sitecore versions, Sitecore modules and Sitecore patches (read [Consuming runtime dependencies](https://sop.pentia.dk/Backend/Package-Management/NuGet/Installing-NuGet-Packages.html#consuming-runtime-dependencies) for details).

4. Open PowerShell in the solution root and run `Publish-WebSolution`.

5. Compare the output to e.g. a test or production webroot, and create supplementary build scripts as needed (e.g. triggering bundling of frontend assets).

## Pentia Builder-based project
TODO

## Pentia Gulp tasks-based project

### `solution-config.json`

* `configurationTransform.AlwaysApplyName` now defaults to "Always" by convention (case insensitive).
* The latest version of `MSBuild.exe` installed on the system is now automatically used for compilation.
* The `configs` section has been replaced with `./pentia/user-settings.json`. See [Solution specific user settings](#solution-specific-user-settings).

#### Before - `solution-config.json`
```json
{
    "configurationTransform": {
      "AlwaysApplyName": "always"
    },
    "msbuild": {
      "showError": true,
      "showStandardOutput": true,
      "toolsversion": 14.0,
      "verbosity": "Minimal"
    },
    "configs": [
      {
        "name": "debug",
        "rootFolder": "C:\\Websites\\HC.website",
        "websiteRoot" :"C:\\Websites\\HC.website\\Website",
        "websiteDataRoot" :"C:\\Websites\\HC.website\\Data"
      },
      {
        "name": "development",
        "rootFolder": "Websites",
        "websiteRoot" :"Websites\\Website",
        "websiteDataRoot" :"Websites\\Data"
      }
    ]
}
```

#### After - `./pentia/user-settings.json`
This file is automatically generated and updated.
```json
{
    "webrootOutputPath":  "C:\\Websites\\HC.website\\Website",
    "dataOutputPath":  "C:\\Websites\\HC.website\\Data",
    "buildConfiguration":  "debug"
}
```

### `solution-packages.json`

This file has been replaced with `runtime-dependencies.config`. See [Runtime dependencies](#runtime-dependencies).

#### Before - `solution-packages.json`
```json
{
    "packages":[
        {
            "packageName": "Sitecore.Full",
            "version": "8.2.170728",
            "location": "http://tund/nuget/FullSitecore/"  
        },
        {
            "packageName": "Sitecore.Publishing.Module",
            "version": "2.0.0",
            "location": "http://tund/nuget/sitecore/"  
        }
    ]
}
```

#### After - `runtime-dependencies.config`
```xml
<?xml version="1.0" encoding="utf-8"?>
<packages>
  <package id="Sitecore.Full" version="8.2.170728" />
  <package id="Sitecore.Publishing.Module" version="2.0.0" />
</packages>
```

### `gulpfile.js`

The scripts called from within `gulpfile.js` (e.g. `Setup-Development-Environment`, which in turn calls `delete-website`, `install-packages` etc.) have been replaced with `Publish-ConfiguredWebSolution`. 
Hence these parts of `gulpfile.js` are largely obsolete.

#### Before - `gulpfile.js`
```javascript
var gulp = require('gulp');
var runSequence = require('run-sequence');
var publish = require('@pentia/publish-projects');
var packagemanager = require('@pentia/sitecore-package-manager');
var configTransform = require('@pentia/configuration-transformer');
var watchprojects = require('@pentia/watch-publish-projects');
var powershell = require('./node_modules/@pentia/publish-projects/modules/powershell')
var rimraf = require('rimraf');
var fs = require('fs-extra');

gulp.task('Setup-Development-Environment', function(callback) {
  runSequence(
    'delete-website',
    'install-packages',
    'publish-all-layers',
    'apply-xml-transform',
    'copy-license',
    'sync',
    callback);
});

gulp.task('sync', function(callback) {
  powershell.runAsync("./autosync-scripts/autosync-unicorn.ps1", "", callback);
});

gulp.task('setup', function(callback) {
  runSequence('Setup-Development-Environment',
    callback);
});

gulp.task('delete-website', function(callback) {
  rimraf('C:\\websites\\HC.website\\Website', callback);
});

gulp.task('copy-license', function() {
  fs.copy('\\\\buildlibrary\\library\\Sitecore License\\Pentia 8.x\\www\\Data\\pentia.license.xml', 'C:\\Websites\\HC.website\\Data\\license.xml');
});
```

#### After - `gulpfile.js`
```javascript
var gulp = require('gulp');
var runSequence = require('run-sequence');
var powershell = require('./node_modules/@pentia/publish-projects/modules/powershell');
var fs = require('fs-extra');

gulp.task('Setup-Development-Environment', function(callback) {
  runSequence('publish-web-solution', 'copy-license', 'sync',  callback);
});

gulp.task('publish-web-solution', function(callback) {
  powershell.runAsync("Publish-ConfiguredWebSolution", "", callback);
});

gulp.task('copy-license', function() {
  var licenseFile = '\\\\buildlibrary\\library\\Sitecore License\\Pentia 8.x\\www\\Data\\pentia.license.xml';
  fs.copy(licenseFile, 'C:\\Websites\\HC.website\\Data\\license.xml');
});

gulp.task('sync', function(callback) {
  powershell.runAsync("./autosync-scripts/autosync-unicorn.ps1", "", callback);
});
```