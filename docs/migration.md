## Migration guide

The following section is a short guide on how to migrate various projects types.

**Note:** The migration guides are 1) backend-centric 2) don't explain how to e.g. create "complimentary setup scripts" for databases, IIS instances etc.

## XDT- and Slow Cheetah-based projects

1. Open PowerShell in the solution root and run the following command to get a list of issues:
```powershell
Get-WebProject | Assert-WebProjectConsistency -BuildConfiguration "<your build configuration>"
``` 

2. Solve all the issues. This is usually done by...

    * renaming files
    * changing build actions for configuration and XDT files
    * uninstalling the Slow Cheetah NuGet package from all projects in the solution (read [SlowCheetah NuGet package](/docs/usage.md#slowcheetah-nuget-package) for details)
    * manually removing all mentions of Slow Cheetah from the `*.csproj` files in the solution.

3. Add any relevant Sitecore versions, Sitecore modules and Sitecore patches (read [Consuming runtime dependencies](https://sop.pentia.dk/Backend/Package-Management/NuGet/Installing-NuGet-Packages.html#consuming-runtime-dependencies) for details).

4. Open PowerShell in the solution root and run `Publish-WebSolution`.

5. Compare the output to e.g. a test or production webroot, and create supplementary build scripts as needed (e.g. triggering bundling of frontend assets).

## Pentia Builder-based project
TODO

## Pentia Gulp tasks-based project

### `solution-config.json`

* `configurationTransform.AlwaysApplyName` now defaults to "Always" by convention (case insensitive).
* The latest version of `MSBuild.exe` installed on the system is now automatically used for compilation.
* The `configs` section has been replaced with `./pentia/user-settings.json`. See [Solution specific user settings](/docs/usage.md#solution-specific-user-settings).

#### Before - `solution-config.json`
```json
{
    "configurationTransform": {
      "AlwaysApplyName": "always"
    },
    "msbuild": {
      "showError": true,
      "showStandardOutput": true,
      "toolsversion": 14.0,
      "verbosity": "Minimal"
    },
    "configs": [
      {
        "name": "debug",
        "rootFolder": "C:\\Websites\\HC.website",
        "websiteRoot" :"C:\\Websites\\HC.website\\Website",
        "websiteDataRoot" :"C:\\Websites\\HC.website\\Data"
      },
      {
        "name": "development",
        "rootFolder": "Websites",
        "websiteRoot" :"Websites\\Website",
        "websiteDataRoot" :"Websites\\Data"
      }
    ]
}
```

#### After - `./pentia/user-settings.json`
This file is automatically generated and updated.
```json
{
    "webrootOutputPath":  "C:\\Websites\\HC.website\\Website",
    "dataOutputPath":  "C:\\Websites\\HC.website\\Data",
    "buildConfiguration":  "debug"
}
```

### `solution-packages.json`

This file has been replaced with `packages.config`. See [Adding Sitecore and Sitecore modules](/docs/usage.md#adding-sitecore-and-sitecore-modules).

#### Before - `solution-packages.json`
```json
{
    "packages":[
        {
            "packageName": "Sitecore.Full",
            "version": "8.2.170728",
            "location": "http://tund/nuget/FullSitecore/"  
        },
        {
            "packageName": "Sitecore.Publishing.Module",
            "version": "2.0.0",
            "location": "http://tund/nuget/sitecore/"  
        }
    ]
}
```

#### After - `packages.config`
```xml
<?xml version="1.0" encoding="utf-8"?>
<packages>
  <package id="Sitecore.Full" version="8.2.170728" />
  <package id="Sitecore.Publishing.Module" version="2.0.0" />
</packages>
```

### `gulpfile.js`

The scripts called from within `gulpfile.js` (e.g. `Setup-Development-Environment`, which in turn calls `delete-website`, `install-packages` etc.) have been replaced with `Publish-ConfiguredWebSolution`. 
Hence these parts of `gulpfile.js` are largely obsolete.

#### Before - `gulpfile.js`
```javascript
var gulp = require('gulp');
var runSequence = require('run-sequence');
var publish = require('@pentia/publish-projects');
var packagemanager = require('@pentia/sitecore-package-manager');
var configTransform = require('@pentia/configuration-transformer');
var watchprojects = require('@pentia/watch-publish-projects');
var powershell = require('./node_modules/@pentia/publish-projects/modules/powershell')
var rimraf = require('rimraf');
var fs = require('fs-extra');

gulp.task('Setup-Development-Environment', function(callback) {
  runSequence(
    'delete-website',
    'install-packages',
    'publish-all-layers',
    'apply-xml-transform',
    'copy-license',
    'sync',
    callback);
});

gulp.task('sync', function(callback) {
  powershell.runAsync("./autosync-scripts/autosync-unicorn.ps1", "", callback);
});

gulp.task('setup', function(callback) {
  runSequence('Setup-Development-Environment',
    callback);
});

gulp.task('delete-website', function(callback) {
  rimraf('C:\\websites\\HC.website\\Website', callback);
});

gulp.task('copy-license', function() {
  fs.copy('\\\\buildlibrary\\library\\Sitecore License\\Pentia 8.x\\www\\Data\\pentia.license.xml', 'C:\\Websites\\HC.website\\Data\\license.xml');
});
```

#### After - `gulpfile.js`
```javascript
var gulp = require('gulp');
var runSequence = require('run-sequence');
var powershell = require('./node_modules/@pentia/publish-projects/modules/powershell');
var fs = require('fs-extra');

gulp.task('Setup-Development-Environment', function(callback) {
  runSequence('publish-web-solution', 'copy-license', 'sync',  callback);
});

gulp.task('publish-web-solution', function(callback) {
  powershell.runAsync("Publish-ConfiguredWebSolution", "", callback);
});

gulp.task('copy-license', function() {
  var licenseFile = '\\\\buildlibrary\\library\\Sitecore License\\Pentia 8.x\\www\\Data\\pentia.license.xml';
  fs.copy(licenseFile, 'C:\\Websites\\HC.website\\Data\\license.xml');
});

gulp.task('sync', function(callback) {
  powershell.runAsync("./autosync-scripts/autosync-unicorn.ps1", "", callback);
});
```

### Migration example - PT.Website2016

Total effort, incl. fixing critical issues and writing documentation ~ 15 hours.

#### packages.config

The migration guide outlined above was used to migrate the `solution-packages.json` file to `packages.config`.

#### Publish-Solution.ps1

1. The base `Publish-Solution.ps1` file was copied from the [Pentia Sitecore Boilerplate project](https://pentia.visualstudio.com/Pentia.SitecoreBoilerplate/_git/Pentia.SitecoreBoilerplate?path=%2FPublish-Solution.ps1).

2. Since the boilerplate script was created for Sitecore 9, and the solution at hand uses Sitecore 8, the `$RoleName` variable was superfluous and simply replaced with `$SolutionName`.

3. The [`Install-EmberFastBoot.ps1`](https://pentia.visualstudio.com/_git/PT.Website%202016?path=%2Finstall-emberfastboot.ps1&version=GCe5f6aa07894eb2179637177d28aafb1425aa7566) script, specific to the solution, was integrated into the `Publish-Solution.ps1` script. A switch parameter was added to disable this step during packaging.

4. The [`SetupIIS.ps1`](https://pentia.visualstudio.com/_git/PT.Website%202016?path=%2FSetup%20website%2FSetupIIS.ps1&version=GCe5f6aa07894eb2179637177d28aafb1425aa7566) script, specific to the solution, was integrated into the `Publish-Solution.ps1` script. A switch parameter was added to disable this step during packaging.

#### New-NuGetPackage.ps1

The [`New-NuGetPackage.ps1`](https://pentia.visualstudio.com/_git/PT.Website%202016/commit/4a10d66ad5408705c8a26aef3272768c2b610dc0?refName=refs%2Fheads%2Fmaster&_a=compare&path=%2FNew-NuGetPackage.ps1) script was created to reduce the amount of "inline script" found in TeamCity and Octopus Deploy.

To support build and deploy script versioning, and general clarity, inline scripts should be kept to an absolute minimum.

#### .gitignore
The following were added:

```
.pentia
output/
```

#### WebPublish MSBuild target

This was the primary cause for developer headaches, as some of the projects had references to VS 2012 and VS 2015 build targets:

1. Remove references to VS 14.0 specific build targets from all web projects (see line 241 in [commit 468b8f8b of PentiaDK.Website.csproj](https://pentia.visualstudio.com/_git/PT.Website%202016/commit/468b8f8b7d932286c277f184ba5f9dafae1f3108?refName=refs%2Fheads%2Fmaster&_a=compare&path=%2Fsrc%2FProject%2FPentiaDK.Website%2FPentiaDK.Website.csproj) for an example).

2. Add the [`MSBuild.Microsoft.VisualStudio.Web.targets`](https://www.nuget.org/packages/MSBuild.Microsoft.VisualStudio.Web.targets/) NuGet package to all web projects (see line 3 in [`PentiaDK.Website.csproj`](https://pentia.visualstudio.com/_git/PT.Website%202016/commit/468b8f8b7d932286c277f184ba5f9dafae1f3108?path=%2Fsrc%2FProject%2FPentiaDK.Website%2FPentiaDK.Website.csproj&gridItemType=2&mpath=%2Fsrc%2FProject%2FPentiaDK.Website%2FPentiaDK.Website.csproj&opath=%2Fsrc%2FProject%2FPentiaDK.Website%2FPentiaDK.Website.csproj&mversion=GC468b8f8b7d932286c277f184ba5f9dafae1f3108&oversion=GCe5f6aa07894eb2179637177d28aafb1425aa7566&_a=compare) and line 5 in [`packages.config`](https://pentia.visualstudio.com/_git/PT.Website%202016/commit/468b8f8b7d932286c277f184ba5f9dafae1f3108?path=%2Fsrc%2FProject%2FPentiaDK.Website%2Fpackages.config&gridItemType=2&mpath=%2Fsrc%2FProject%2FPentiaDK.Website%2Fpackages.config&opath=%2Fsrc%2FProject%2FPentiaDK.Website%2Fpackages.config&mversion=GC468b8f8b7d932286c277f184ba5f9dafae1f3108&oversion=GCe5f6aa07894eb2179637177d28aafb1425aa7566&_a=compare) for an example).

#### TeamCity

TeamCity build pipelines for [Pentia.dk](http://buildserver/viewType.html?buildTypeId=PentiaDkWebsite_CreateReleaseOnOctopus) and [Pentia.se](http://buildserver/viewType.html?buildTypeId=PentiaDkWebsite_CreateReleaseOnOctopusPentiaSe) were modified to use the new build scripts for NuGet package creation.

#### Unforseen critical issue - Sitecore data folder location

The Sitecore data folder was placed inside the webroot, without any form of access control.
This allowed our Sitecore partner license to be downloaded via https://pentia.dk/data/license.xml.

#### Unforseen critical issue - Pentia.se

The existance of Pentia.se only became apparent after inspecting the deployment pipeline in Octopus Deploy.
It's not mentioned anywhere on the intranet!

This meant time had to be spent updating the documentation.
